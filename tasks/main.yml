---

- name: Install package dependencies
  apt: 
    pkg:
      - curl
      - gnupg
      - python3

- name: Make dirs
  file:
    path:
    - "/etc/apt/trusted.gpg.d"
    - "/etc/apt/sources.list.d"
    state: directory

- include_tasks:
    file: apt_gpg.yml

- name: Gather dpkg architecture info
  shell: "dpkg --print-architecture"
  register: dpkg_content
  changed_when: false

- name: Set system info
  set_fact:
    version_os: "{{ hostvars[inventory_hostname].ansible_distribution | lower }}"
    version_codename: "{{ hostvars[inventory_hostname].ansible_distribution_release | lower }}"
    arch: "{{ dpkg_content.stdout | lower }}"
  changed_when: false

# if ansible-core >= 2.15
#
# - name: Add Jellyfin repo
#   deb822_repository:
#     name: jellyfin
#     types: deb
#     uris: "https://repo.jellyfin.org/{{ version_os }}"
#     suites: "{{ version_codename }}"
#     components: main
#     architectures: "{{ arch }}"
#     signed_by: /etc/apt/trusted.gpg.d/jellyfin.pgp

- name: Add Jellyfin Repo
  template:
    src: "jellyfin.sources.jinja"
    dest: "/etc/apt/sources.list.d/jellyfin.sources"

- name: Install Jellyfin
  apt:
    name: "jellyfin"
    state: "latest"
    update_cache: yes
  loop:
    - "jellyfin-web"
    - "jellyfin-server"

- include_tasks:
    file: dirs.yml

- include_tasks:
    file: config.yml

- name: Restart and enable Jellyfin systemd service
  systemd:
    name: jellyfin.service
    state: restarted
    enabled: true
  when: not (jellyfin_skip_restart | bool)

- name: Message
  debug:
    msg: "Please setup Jellyfin in the Webinterface at http://SERVER_IP:8096"
